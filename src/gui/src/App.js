import { UploadOutlined } from '@ant-design/icons';
import { Button, Upload, Row, Col, Collapse } from 'antd';
import 'antd/dist/antd.css';
import React from 'react';
import { launchGameboy, startGameboy, stepGameboy, getMemoryAt } from './gb';
import { readFileAsBinary } from './utils';
import GBBinaryBuilder from './GBBinaryBuilder';
import { MemoryInspector } from './MemoryInspector';
import { subscribe } from './Stroage';
import { CPUDisplay } from './CPUDisplay';

class App extends React.Component {

    debugger() {
        const { gb_ptr, gb } = this.props.container.state;
        if (!gb_ptr) return;
        const cpu = gb.deref('cpu');
        const { label, length } = OPCODES_DEFINITIONS[getMemoryAt(gb_ptr, cpu.PC)];

        return <Collapse.Panel header="Debugger">
            <Button onClick={() => { stepGameboy(gb_ptr); this.forceUpdate() }}>Step</Button>
            <span>Instruction: <b>{label}</b></span>
            <Row gutter={24}>
                <Col span={12}><CPUDisplay cpu={cpu} /></Col>
                <Col span={12}><MemoryInspector memory_address={cpu.PC} gb_ptr={gb_ptr} highlightBinary={[0, length]} /></Col>
            </Row>
        </Collapse.Panel>
    }

    render() {
        const { gb_ptr } = this.props.container.state;
        return <div>
            <Upload
                transformFile={readFileAsBinary}
                customRequest={({ file: rom }) => launchGameboy(rom)}
                showUploadList={false}
            >
                <Button><UploadOutlined /> Choose a ROM</Button>
            </Upload>
            <Button onClick={() => startGameboy(gb_ptr)}>Start</Button>
            <Collapse>
                {this.debugger()}
                <Collapse.Panel header="Binary Builder"><GBBinaryBuilder /></Collapse.Panel>
            </Collapse>
        </div>
    }

}

export default subscribe(App);

const OPCODES_DEFINITIONS = [{ "label": "NOP", "length": 1 }, { "label": "LD BC,d16", "length": 3 }, { "label": "LD (BC),A", "length": 1 }, { "label": "INC BC", "length": 1 }, { "label": "INC B", "length": 1 }, { "label": "DEC B", "length": 1 }, { "label": "LD B,d8", "length": 2 }, { "label": "RLCA", "length": 1 }, { "label": "LD (a16),SP", "length": 3 }, { "label": "ADD HL,BC", "length": 1 }, { "label": "LD A,(BC)", "length": 1 }, { "label": "DEC BC", "length": 1 }, { "label": "INC C", "length": 1 }, { "label": "DEC C", "length": 1 }, { "label": "LD C,d8", "length": 2 }, { "label": "RRCA", "length": 1 }, { "label": "STOP 0", "length": 2 }, { "label": "LD DE,d16", "length": 3 }, { "label": "LD (DE),A", "length": 1 }, { "label": "INC DE", "length": 1 }, { "label": "INC D", "length": 1 }, { "label": "DEC D", "length": 1 }, { "label": "LD D,d8", "length": 2 }, { "label": "RLA", "length": 1 }, { "label": "JR r8", "length": 2 }, { "label": "ADD HL,DE", "length": 1 }, { "label": "LD A,(DE)", "length": 1 }, { "label": "DEC DE", "length": 1 }, { "label": "INC E", "length": 1 }, { "label": "DEC E", "length": 1 }, { "label": "LD E,d8", "length": 2 }, { "label": "RRA", "length": 1 }, { "label": "JR NZ,r8", "length": 2 }, { "label": "LD HL,d16", "length": 3 }, { "label": "LD (HL+),A", "length": 1 }, { "label": "INC HL", "length": 1 }, { "label": "INC H", "length": 1 }, { "label": "DEC H", "length": 1 }, { "label": "LD H,d8", "length": 2 }, { "label": "DAA", "length": 1 }, { "label": "JR Z,r8", "length": 2 }, { "label": "ADD HL,HL", "length": 1 }, { "label": "LD A,(HL+)", "length": 1 }, { "label": "DEC HL", "length": 1 }, { "label": "INC L", "length": 1 }, { "label": "DEC L", "length": 1 }, { "label": "LD L,d8", "length": 2 }, { "label": "CPL", "length": 1 }, { "label": "JR NC,r8", "length": 2 }, { "label": "LD SP,d16", "length": 3 }, { "label": "LD (HL-),A", "length": 1 }, { "label": "INC SP", "length": 1 }, { "label": "INC (HL)", "length": 1 }, { "label": "DEC (HL)", "length": 1 }, { "label": "LD (HL),d8", "length": 2 }, { "label": "SCF", "length": 1 }, { "label": "JR C,r8", "length": 2 }, { "label": "ADD HL,SP", "length": 1 }, { "label": "LD A,(HL-)", "length": 1 }, { "label": "DEC SP", "length": 1 }, { "label": "INC A", "length": 1 }, { "label": "DEC A", "length": 1 }, { "label": "LD A,d8", "length": 2 }, { "label": "CCF", "length": 1 }, { "label": "LD B,B", "length": 1 }, { "label": "LD B,C", "length": 1 }, { "label": "LD B,D", "length": 1 }, { "label": "LD B,E", "length": 1 }, { "label": "LD B,H", "length": 1 }, { "label": "LD B,L", "length": 1 }, { "label": "LD B,(HL)", "length": 1 }, { "label": "LD B,A", "length": 1 }, { "label": "LD C,B", "length": 1 }, { "label": "LD C,C", "length": 1 }, { "label": "LD C,D", "length": 1 }, { "label": "LD C,E", "length": 1 }, { "label": "LD C,H", "length": 1 }, { "label": "LD C,L", "length": 1 }, { "label": "LD C,(HL)", "length": 1 }, { "label": "LD C,A", "length": 1 }, { "label": "LD D,B", "length": 1 }, { "label": "LD D,C", "length": 1 }, { "label": "LD D,D", "length": 1 }, { "label": "LD D,E", "length": 1 }, { "label": "LD D,H", "length": 1 }, { "label": "LD D,L", "length": 1 }, { "label": "LD D,(HL)", "length": 1 }, { "label": "LD D,A", "length": 1 }, { "label": "LD E,B", "length": 1 }, { "label": "LD E,C", "length": 1 }, { "label": "LD E,D", "length": 1 }, { "label": "LD E,E", "length": 1 }, { "label": "LD E,H", "length": 1 }, { "label": "LD E,L", "length": 1 }, { "label": "LD E,(HL)", "length": 1 }, { "label": "LD E,A", "length": 1 }, { "label": "LD H,B", "length": 1 }, { "label": "LD H,C", "length": 1 }, { "label": "LD H,D", "length": 1 }, { "label": "LD H,E", "length": 1 }, { "label": "LD H,H", "length": 1 }, { "label": "LD H,L", "length": 1 }, { "label": "LD H,(HL)", "length": 1 }, { "label": "LD H,A", "length": 1 }, { "label": "LD L,B", "length": 1 }, { "label": "LD L,C", "length": 1 }, { "label": "LD L,D", "length": 1 }, { "label": "LD L,E", "length": 1 }, { "label": "LD L,H", "length": 1 }, { "label": "LD L,L", "length": 1 }, { "label": "LD L,(HL)", "length": 1 }, { "label": "LD L,A", "length": 1 }, { "label": "LD (HL),B", "length": 1 }, { "label": "LD (HL),C", "length": 1 }, { "label": "LD (HL),D", "length": 1 }, { "label": "LD (HL),E", "length": 1 }, { "label": "LD (HL),H", "length": 1 }, { "label": "LD (HL),L", "length": 1 }, { "label": "HALT", "length": 1 }, { "label": "LD (HL),A", "length": 1 }, { "label": "LD A,B", "length": 1 }, { "label": "LD A,C", "length": 1 }, { "label": "LD A,D", "length": 1 }, { "label": "LD A,E", "length": 1 }, { "label": "LD A,H", "length": 1 }, { "label": "LD A,L", "length": 1 }, { "label": "LD A,(HL)", "length": 1 }, { "label": "LD A,A", "length": 1 }, { "label": "ADD A,B", "length": 1 }, { "label": "ADD A,C", "length": 1 }, { "label": "ADD A,D", "length": 1 }, { "label": "ADD A,E", "length": 1 }, { "label": "ADD A,H", "length": 1 }, { "label": "ADD A,L", "length": 1 }, { "label": "ADD A,(HL)", "length": 1 }, { "label": "ADD A,A", "length": 1 }, { "label": "ADC A,B", "length": 1 }, { "label": "ADC A,C", "length": 1 }, { "label": "ADC A,D", "length": 1 }, { "label": "ADC A,E", "length": 1 }, { "label": "ADC A,H", "length": 1 }, { "label": "ADC A,L", "length": 1 }, { "label": "ADC A,(HL)", "length": 1 }, { "label": "ADC A,A", "length": 1 }, { "label": "SUB B", "length": 1 }, { "label": "SUB C", "length": 1 }, { "label": "SUB D", "length": 1 }, { "label": "SUB E", "length": 1 }, { "label": "SUB H", "length": 1 }, { "label": "SUB L", "length": 1 }, { "label": "SUB (HL)", "length": 1 }, { "label": "SUB A", "length": 1 }, { "label": "SBC A,B", "length": 1 }, { "label": "SBC A,C", "length": 1 }, { "label": "SBC A,D", "length": 1 }, { "label": "SBC A,E", "length": 1 }, { "label": "SBC A,H", "length": 1 }, { "label": "SBC A,L", "length": 1 }, { "label": "SBC A,(HL)", "length": 1 }, { "label": "SBC A,A", "length": 1 }, { "label": "AND B", "length": 1 }, { "label": "AND C", "length": 1 }, { "label": "AND D", "length": 1 }, { "label": "AND E", "length": 1 }, { "label": "AND H", "length": 1 }, { "label": "AND L", "length": 1 }, { "label": "AND (HL)", "length": 1 }, { "label": "AND A", "length": 1 }, { "label": "XOR B", "length": 1 }, { "label": "XOR C", "length": 1 }, { "label": "XOR D", "length": 1 }, { "label": "XOR E", "length": 1 }, { "label": "XOR H", "length": 1 }, { "label": "XOR L", "length": 1 }, { "label": "XOR (HL)", "length": 1 }, { "label": "XOR A", "length": 1 }, { "label": "OR B", "length": 1 }, { "label": "OR C", "length": 1 }, { "label": "OR D", "length": 1 }, { "label": "OR E", "length": 1 }, { "label": "OR H", "length": 1 }, { "label": "OR L", "length": 1 }, { "label": "OR (HL)", "length": 1 }, { "label": "OR A", "length": 1 }, { "label": "CP B", "length": 1 }, { "label": "CP C", "length": 1 }, { "label": "CP D", "length": 1 }, { "label": "CP E", "length": 1 }, { "label": "CP H", "length": 1 }, { "label": "CP L", "length": 1 }, { "label": "CP (HL)", "length": 1 }, { "label": "CP A", "length": 1 }, { "label": "RET NZ", "length": 1 }, { "label": "POP BC", "length": 1 }, { "label": "JP NZ,a16", "length": 3 }, { "label": "JP a16", "length": 3 }, { "label": "CALL NZ,a16", "length": 3 }, { "label": "PUSH BC", "length": 1 }, { "label": "ADD A,d8", "length": 2 }, { "label": "RST 00H", "length": 1 }, { "label": "RET Z", "length": 1 }, { "label": "RET", "length": 1 }, { "label": "JP Z,a16", "length": 3 }, { "label": "PREFIX CB", "length": 1 }, { "label": "CALL Z,a16", "length": 3 }, { "label": "CALL a16", "length": 3 }, { "label": "ADC A,d8", "length": 2 }, { "label": "RST 08H", "length": 1 }, { "label": "RET NC", "length": 1 }, { "label": "POP DE", "length": 1 }, { "label": "JP NC,a16", "length": 3 }, null, { "label": "CALL NC,a16", "length": 3 }, { "label": "PUSH DE", "length": 1 }, { "label": "SUB d8", "length": 2 }, { "label": "RST 10H", "length": 1 }, { "label": "RET C", "length": 1 }, { "label": "RETI", "length": 1 }, { "label": "JP C,a16", "length": 3 }, null, { "label": "CALL C,a16", "length": 3 }, null, { "label": "SBC A,d8", "length": 2 }, { "label": "RST 18H", "length": 1 }, { "label": "LDH (a8),A", "length": 2 }, { "label": "POP HL", "length": 1 }, { "label": "LD (C),A", "length": 1 }, null, null, { "label": "PUSH HL", "length": 1 }, { "label": "AND d8", "length": 2 }, { "label": "RST 20H", "length": 1 }, { "label": "ADDSP,r8", "length": 2 }, { "label": "JP (HL)", "length": 1 }, { "label": "LD (a16),A", "length": 3 }, null, null, null, { "label": "XOR d8", "length": 2 }, { "label": "RST 28H", "length": 1 }, { "label": "LDH A,(a8)", "length": 2 }, { "label": "POP AF", "length": 1 }, { "label": "LD A,(C)", "length": 1 }, { "label": "DI", "length": 1 }, null, { "label": "PUSH AF", "length": 1 }, { "label": "OR d8", "length": 2 }, { "label": "RST 30H", "length": 1 }, { "label": "LDHL SP,r8", "length": 2 }, { "label": "LD SP,HL", "length": 1 }, { "label": "LD A,(a16)", "length": 3 }, { "label": "EI", "length": 1 }, null, null, { "label": "CP d8", "length": 2 }, { "label": "RST 38H", "length": 1 }];
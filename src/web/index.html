<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    Load ROM: <input id="rom-file" type="file" />
    <script src="./gb_lib.js"></script>
    <script>
        const romUpload = document.querySelector('#rom-file');
        if (!romUpload) {
            throw new Error('rom upload button not found');
        }
        romUpload.onchange = async () => {
            if (romUpload.value === '') {
                return;
            }
            if (romUpload.files && romUpload.files.length >= 1) {
                const rom = await loadROMFile(romUpload.files[0]);
                Module['FS_createDataFile']('/', 'cartridge_rom', rom, true, true, true);
                window.gb = Module._launch_gameboy();
            }
        }

        function loadROMFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const { result } = reader;
                    if (result instanceof ArrayBuffer) {
                        resolve(new Uint8Array(result));
                    } else {
                        reject('Failed to read file');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }
    </script>
</body>

</html>